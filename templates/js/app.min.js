var app = angular.module('geocoreApp', []);
app.directive('customOnChange', function() {
    return {
        restrict: 'A',
        link: function (scope, element, attrs) {
        var onChangeHandler = scope.$eval(attrs.customOnChange);
        element.bind('change', onChangeHandler);
        }
    };
});

app.controller('indexController', function($scope, $http) {
    $scope.firstName = "John";
    $scope.lastName = "Doe";
    $scope.uploaded_shapefiles = [];
    $scope.download_tiles = function(download_link){
        window.open('/static/resources/download/' + download_link);
    };

    $scope.btn_uploadShapefile = function(){
        var input = $("#upload-new-shapefile");
        input.replaceWith(input.val('').clone(true));
        $('#upload-new-shapefile').click();
    };

    $scope.uploadShapefile = function(e){
        var url = "uploadzipshapefile/";
        var file = document.getElementById('upload-new-shapefile').files[0];

        if(file != null){
            var config = { 
                headers: { "Content-Type": "application/octet-stream" },
                params: { filename: file.name,
                    size: file.size,
                    type: file.type
                }
            };
            console.log(config);
            $http.post(url, file, config).then( function(response) 
            {
                if('status' in response.data && response.data.status == 'success'){
                    $scope.getshapefiles();
                    alert('Successfully uploaded the shapefile.');
                }
                else{
                    alert('Failed to upload the shapefile. Please check your file.');
                }

            }).catch(function(error){
                alert("Failed to upload the shapefile. Please check your file.");
            });
        }
    };

    $scope.getshapefiles = function(){
        var url = "getshapefiles/";
        var params = {};
        $http({
            method: 'POST',
            url: url,
            data: params,
            headers: {'Content-Type': 'application/x-www-form-urlencoded'}
        }).then(function successCallback(response) {
            if('status' in response.data && response.data.status == 'success'){
                $scope.uploaded_shapefiles = response.data.shapefiles;
                console.log(response.data);
            }
            else{
                console.log('Failed to get shapefile list.');
            }
        },function errorCallback(response) {
            console.log('Failed to get shapefile list.');
        });
    };

    $scope.getshapefiles();
});